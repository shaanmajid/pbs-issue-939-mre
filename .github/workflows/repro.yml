name: repro

on:
  push:
  workflow_dispatch:

jobs:
  pbs-build-matrix:
    name: ${{ matrix.pbs.id }} / py${{ matrix.python-version }} / expect-${{ matrix.pbs.expect }}
    runs-on: macos-14
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        pbs:
          - id: upstream-main
            repository: astral-sh/python-build-standalone
            ref: main
            expect: fail
          - id: fix-branch
            repository: shaanmajid/python-build-standalone
            ref: fix/tkinter-tcl-library-env
            expect: pass
    steps:
      - uses: actions/checkout@v4

      - name: Checkout python-build-standalone
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.pbs.repository }}
          ref: ${{ matrix.pbs.ref }}
          path: pbs
          fetch-depth: 1

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Print build tool versions
        run: |
          set -euxo pipefail
          sw_vers
          uv --version
          rustc --version
          cargo --version

      - name: Build python-build-standalone
        working-directory: pbs
        run: |
          set -euxo pipefail
          ./build.py \
            --target-triple aarch64-apple-darwin \
            --python cpython-${{ matrix.python-version }} \
            --options noopt

      - name: Prepare built Python
        run: |
          set -euxo pipefail
          dist_archive=$(find pbs/dist -maxdepth 1 -type f -name '*.tar.zst' | head -n 1)
          if [ -z "${dist_archive}" ]; then
            echo "No built archive found in pbs/dist/"
            exit 1
          fi
          echo "dist_archive=${dist_archive}" >> "$GITHUB_ENV"

          extract_root="$RUNNER_TEMP/pbs-dist"
          rm -rf "$extract_root"
          mkdir -p "$extract_root"
          tar --zstd -xf "${dist_archive}" -C "$extract_root"

          python_bin="$extract_root/python/install/bin/python3"
          if [ ! -x "$python_bin" ]; then
            echo "Expected built Python at $python_bin, but it is missing."
            find "$extract_root" -maxdepth 4 -type f | sed -n '1,200p'
            exit 1
          fi
          echo "python_bin=${python_bin}" >> "$GITHUB_ENV"

          venv_dir="$RUNNER_TEMP/mre-venv"
          rm -rf "$venv_dir"
          "$python_bin" -m venv "$venv_dir"
          echo "venv_python=$venv_dir/bin/python" >> "$GITHUB_ENV"

      - name: Verify trigger conditions
        run: |
          set -euxo pipefail
          "$venv_python" - <<'PY' < /dev/null
          import os
          import stat
          import sys

          if sys.prefix == sys.base_prefix:
              raise SystemExit(
                  f"Expected sys.prefix != sys.base_prefix; got {sys.prefix!r} == {sys.base_prefix!r}"
              )

          stdin_mode = os.fstat(0).st_mode
          if not stat.S_ISCHR(stdin_mode):
              raise SystemExit(f"Expected stdin to be a character device; mode={oct(stdin_mode)}")
          if os.isatty(0):
              raise SystemExit("Expected stdin to be non-TTY")

          print("Trigger conditions satisfied.")
          print(f"prefix={sys.prefix}")
          print(f"base_prefix={sys.base_prefix}")
          print(f"stdin_mode={oct(stdin_mode)}")
          print(f"stdin_isatty={os.isatty(0)}")
          PY

      - name: Run MRE and assert expected behavior
        id: assert
        run: |
          set -o pipefail
          set +e
          "$venv_python" "$GITHUB_WORKSPACE/mre.py" < /dev/null 2>&1 | tee "$RUNNER_TEMP/mre.log"
          status=${PIPESTATUS[0]}
          set -e

          echo "mre_exit_code=$status" >> "$GITHUB_OUTPUT"

          if [ "${{ matrix.pbs.expect }}" = "fail" ]; then
            if [ "$status" -eq 0 ]; then
              echo "Expected MRE failure for ${{ matrix.pbs.repository }}@${{ matrix.pbs.ref }}, but it succeeded."
              exit 1
            fi
            echo "Observed expected failure."
          else
            if [ "$status" -ne 0 ]; then
              echo "Expected MRE success for ${{ matrix.pbs.repository }}@${{ matrix.pbs.ref }}, but it failed."
              exit 1
            fi
            echo "Observed expected success."
          fi

      - name: Upload MRE log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mre-log-${{ matrix.pbs.id }}-py${{ matrix.python-version }}
          path: ${{ runner.temp }}/mre.log
          if-no-files-found: warn

      - name: Write step summary
        if: always()
        run: |
          if [ "${{ steps.assert.outcome }}" = "success" ]; then
            assertion="matched expected behavior"
          else
            assertion="did not match expected behavior"
          fi

          {
            echo "### PBS build + MRE result"
            echo ""
            echo "- Python version: \`${{ matrix.python-version }}\`"
            echo "- PBS source: \`${{ matrix.pbs.repository }}@${{ matrix.pbs.ref }}\`"
            echo "- Expected MRE result: \`${{ matrix.pbs.expect }}\`"
            echo "- MRE exit code: \`${{ steps.assert.outputs.mre_exit_code || 'n/a' }}\`"
            echo "- Assertion: \`${assertion}\`"
          } >> "$GITHUB_STEP_SUMMARY"
